<include file="Public:header" />
<link href="__PUBLIC__/css/litebox.css" rel="stylesheet" type="text/css">
<link href="__PUBLIC__/css/page/leadsIndex.css" rel="stylesheet" type="text/css">
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<!-- nice-scroll -->
<!-- <script src="__PUBLIC__/style/js/plugins/nice-scroll/jquery.nicescroll.min.js" type="text/javascript"></script> -->
<script src="https://nicescroll.areaaperta.com/wp-content/plugins/jnicescroll/js/jquery.nicescroll.min.js?ver=1"></script>
<script type="text/javascript" src="__PUBLIC__/style/js/TableFreeze.js"></script>
<script src="__PUBLIC__/js/mxcrm_more.js" type="text/javascript"></script>

<link rel="stylesheet" href="/Public/js/jqGrid/ui.jqgridffe4.css">
<link rel="stylesheet" href="/Public/css/page/publicTable.css">
<script src="/Public/js/jqGrid/i18n/grid.locale-cnffe4.js" type="text/javascript"></script>
<script src="/Public/js/jqGrid/jquery.jqGrid.minffe4.js" type="text/javascript"></script>
<script type="text/javascript">
    //实例化编辑器
    window.UEDITOR_UPLOAD_URL = "{:U('file/editor')}";
</script>

<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/ueditor.all.js"> </script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/lang/zh-cn/zh-cn.js"></script>

<style>
    body{
        overflow-y: hidden;
    }
    .table{max-width: none;}
    input[type=text],select{
        appearance:none;
        -moz-appearance:none;
        -webkit-appearance:none;
    }
</style>
<div class="wrapper wrapper-content">
    <include file="Public:alert" />
    <div class="row" id="table_container">
        <div class="col-md-12">
            <div class="title-bar" style="position: relative;z-index: 99;">
                <div id="title-show" class="clearfix">
                    <ul class="searchpart clearfix">
                        <!-- 925 仅 管理员 和 教务 可操作 -->
                        <if condition="session('?admin') || in_array(1,session('edu_roles'))">
                            <a href="{:U('educationview/section_cate_add')}" class="btn btn-primary btn-sm pull-left" style="margin:2px 0 0 0; width: 100px;" >
                                <i class="fa fa-plus-circle"></i>&nbsp; 新建课程
                            </a>
                        </if>
                        <select id="search_courses" class="form-control" style="width: 300px;float: right;" @change="reloadgrid()">
                            <!-- 删选条件 JS 渲染 -->
                            <option value="">请选择班级</option>
                            <option :value="n.id" v-for="n in optionarr">{{n.name}}</option>
                        </select>
                    </ul>
                </div>
            </div>
            <form id="form1" action="" method="post" style="position:relative;">

                <div class="row" style="margin: 0">
                    <div class="ibox-box" style="padding:0px;border:none;">
                        <div class="table_vue">
                            <table class="table" id="table_list_2"></table>
                            <!-- 分页 -->
                            <div id="gridpager"></div>
                        </div>
                    </div>
                </div>

                <div class="cover"></div>
                <div class="loader" id="loader">
                    <div class="loader-inner pacman">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- 弹框 -->
<div style="display:none" id="dialog-course-add" title="添加课程">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div style="display:none" id="dialog-course-edit" title="修改班级">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<script>
    $(function(){
        table();
    });
    //请求参数
    var _requert = {};
    var icheck_num = 0;
    //table
    function table(){
        $("#table_list_2").clearGridData();

        $.jgrid.defaults.styleUI = "Bootstrap";

        var _height = $(window).height() - ($(".title-bar").outerHeight() + $("#gridpager").outerHeight() + $("#secondPart").height() + 260);

        var icheck_num = 0;
        var d_width = $(".table_vue").width() - 16;
        $("#table_list_2").jqGrid({
            url:"{:U('education/course_manage')}",
            datatype: "JSON",
            mtype: "post",
            width: "100%",
            postData: _requert,
            height: _height,
            autowidth: true,
            forceFit: true,
            autoScroll: true,
            multiselect: true,
            useColSpanStyle: true,
            colNames: ["id","课程名称", "课时数", "创建人","创建时间","操作"],
            colModel: [{
                name: "id",
                index: "id",
                editable: false,
                sorttype: "text",
                search: true,
                hidden:true
            },{
                name: "name",
                index: "name",
                editable: false,
                sorttype: "text",
                search: true,
                formatter:name_format
            }, {
                name: "section_num",
                index: "section_num",
                editable: false,
                sorttype: "text",
                search: true
            }, {
                name: "create_user",
                index: "create_user",
                editable: false,
                sorttype: "text",
                search: true
            },{
                name:"create_time",
                index: "create_time",
                editable: false,
                sorttype: "text",
                search: true
            },{
                name:"id",
                index: "id",
                editable: false,
                sorttype: "text",
                search: true,
                formatter:btngroup
            }],
            forceFit: true,
            //分页
            rowNum: 30,
            rowList: [5, 10, 30],
            pager: '#gridpager',
            viewrecords: true,
            jsonReader: {
                repeatitems: false,
                root: "lists",
                records: "count",
                total: "total"
            },
            hidegrid: false,
            beforeSelectRow: function (rowid, e) {
                var $myGrid = $(this),
                    i = $.jgrid.getCellIndex($(e.target).closest('td')[0]),
                    cm = $myGrid.jqGrid('getGridParam', 'colModel');
                return (cm[i].name === 'cb');
            } ,
            loadComplete: function (res) {
                // <option value="id">name</option>
                table_container.optionarr = res.banji
            },
            gridComplete: function () {
                setWidthHeight();
            },
            onSelectRow: function (rowid, status) {
                $('.title-bar').hide();
                if (status) {
                    icheck_num = icheck_num + 1;
                } else {
                    icheck_num = icheck_num - 1;
                }
                if (icheck_num == 0) {
                    $('.title-bar').show();
                }
            },
            onSelectAll: function (s, sx) {
                if (sx) {
                    $('.title-bar').hide();
                    icheck_num = s.length
                } else {
                    $('.title-bar').show();
                    icheck_num = 0
                }
            }
        }).trigger("reloadGrid"); //重新载入


        jQuery("#table_list_2").jqGrid('navGrid', '#gridpager', {edit: false, add: false, del: false, search: false}, {}, {}, {multipleSearch: true, multipleGroup: true});

        $('.ui-jqgrid-bdiv').niceScroll({
            cursorcolor: "#77B8FF",
            cursoropacitymax: 1,
            cursorwidth: "4px",
            cursorborder: "0",
            cursorborderradius: "0px",
            autohidemode: false
        });

        $('.nicescroll-rails').eq(2).remove()

        $(window).bind("resize", function () {
            setWidthHeight();
        })
    }
    //设置table高度
    function setWidthHeight(){
        var _height,width;
        _height = $(window).height() - ($(".title-bar").outerHeight() + $("#gridpager").outerHeight()) - 190;
        width = $(".table_vue").width();
        $("#table_list_2").setGridWidth(width)
        $("#table_list_2").setGridHeight(_height)
    }
    //过滤成员属性
    function member_format(cellvalue, options, cell){
        if (cellvalue == 1) {
            return '多成员'
        }else{
            return '单成员'
        }
    }
    //渲染表格最后一列...操作按钮
    function btngroup(cellvalue, options, cell){
        // 925 仅管理员可操作
            <if condition="session('?admin')">
                return '<buttion class="btn btn-info btn-sm" type="button" style="margin-right:5px;" onclick="courseEdit('+cellvalue+')">修改</buttion><button class="btn btn-danger btn-sm" type="button" onclick="courseDel('+cellvalue+')">删除</button>'
            <else/>
                return ''
            </if>
    }
    //课程名称
    function name_format(cellvalue, options, cell){
        return '<a class="a_name" href="javascript:;" onclick="gotoDetail('+options.rowId+')">'+cellvalue+'</a>';
    }

    //下拉刷新
    var table_container = new Vue({
        el: "#table_container",
        data: {
            lists:{},
            nodata:{},
            optionarr:[]
        },
        methods:{
            reloadgrid:function (n) {
                $("#table_list_2").jqGrid("setGridParam", { postData: {banji_id:$("#search_courses").val()}}).trigger("reloadGrid");
            },
            getLists: function () {
                var _this		=	this;
                $.ajax({
                    url:"{:U('education/course_index')}",
                    data:{},
                    dataType:"JSON",
                    type:"GET",
                    success:function(res){
                        if( res.result == false || !res.lists ){
                            _this.nodata = true;
                        }else{
                            _this.nodata = false;
                        }
                        _this.lists = res.lists;
                    }
                });

                dd( _this.nodata );
            },
        },
    });

    /**
     * @ 详情
     * @param a
     */
    function gotoDetail(a) {
        var id = a;
        if( !id ) return ;
        window.open("{:U('educationview/course_manage_detail')}&id="+id);
    }
    /**
     * @编辑
     * @param btn
     */
    function courseEdit (btn){
        var id = btn;
        if( !id ) return ;
        window.location.href='{:U("educationview/course_manage_edit")}&id='+id;
    }
    /**
     * @ 删除
     * @param btn
     */
    function courseDel (btn){
        var id = btn;
        if( !id ) return ;
        layer.confirm('确定删除课程吗?', {icon: 3, title:'提示'}, function(index){
            // 删除
            $.ajax({
                url:"/index.php?m=education&a=section_cate_del",
                data:{id:id},
                dataType:"JSON",
                type:"POST",
                success:function (res) {
                    if( res.result ){

                        $("#table_list_2").jqGrid("setGridParam", { postData: {}}).trigger("reloadGrid");
                        layer.msg('课程删除成功！');
                    }else{
                        layer.msg('ERROR '+res.error);
                    }
                }
            });
            layer.close(index);
        });
    }
    // /**
    //  * @ 添加课程
    //  */
    // function course_add (){
    //     $('#dialog-course-add').dialog('open');
    //     $('#dialog-course-add').load('{:U("educationview/section_cate_add")}');
    // }

    /**
     * @ 定义添加课程
     */
    $("#dialog-course-add").dialog({
        autoOpen: false,
        modal: true,
        width: '55%',
        maxHeight: 600,
        position: ["center",100],
        buttons:{
            '添加':function(){
                // 操作
                var data       		=   new FormData(),
                    file			=	document.getElementById('main_pic').files[0],
                    form_data       =   $("#course_add_form").serializeArray(),
                    _dialog         =   this;

                form_data.forEach(function (v) {
                    data.append(v.name,v.value);
                });
                file && data.append('pic',file);

                dd(file);
                dd(data);

                $.ajax({
                    url:"{:U('education/course_add')}",
                    data:data,
                    dataType:"JSON",
                    type:"POST",
                    processData:false,
                    contentType:false,
                    async:false,
                    success:function (res) {
                        if( res.result ){
                            // 刷新主页数据

                            $("#table_list_2").jqGrid("setGridParam", { postData: {}}).trigger("reloadGrid");
                            //
                            layer.msg( '添加课程成功！' );
                            // 关闭弹框
                            $(_dialog).dialog('close');

                        }else{
                            layer.msg('ERROR '+res.error);
                        }
                    }
                });
                return;
            },
            '取消':function(){
                $(this).dialog('close');
            }
        },
        close:function(){
            $(this).html('');
        }
    });
    /**
     * @ 定义修改课程
     */
    $("#dialog-course-edit").dialog({
        autoOpen: false,
        modal: true,
        width: '55%',
        maxHeight: 600,
        position: ["center",100],
        buttons:{
            '修改':function(){
                // 操作
                var data       		=   new FormData(),
                    file			=	document.getElementById('main_pic').files[0],
                    form_data       =   $("#course_add_form").serializeArray(),
                    _dialog         =   this;

                form_data.forEach(function (v) {
                    data.append(v.name,v.value);
                });
                file && data.append('pic',file);

                $.ajax({
                    url:"{:U('education/course_edit')}",
                    data:data,
                    dataType:"JSON",
                    type:"POST",
                    processData:false,
                    contentType:false,
                    async:false,
                    success:function (res) {
                        if( res.result ){
                            // 刷新主页数据

                            $("#table_list_2").jqGrid("setGridParam", { postData: {}}).trigger("reloadGrid");
                            //
                            layer.msg( '课程修改成功！' );
                            // 关闭弹框
                            $(_dialog).dialog('close');

                        }else{
                            layer.msg('ERROR '+res.error);
                        }
                    }
                });
                return;
            },
            '取消':function(){
                $(this).dialog('close');
            }
        },
        close:function(){
            $(this).html('');
        }
    });

    function dd(data){
        console.log(data);
        return ;
    }
</script>


<include file="Public:footer" />