<link rel="stylesheet" href="/Public/js/jqGrid/ui.jqgridffe4.css">
<link rel="stylesheet" href="/Public/css/page/publicTable.css">
<link rel="stylesheet" href="/Public/css/page/record_schedule_list.css">
<include file="Public:header" />
<style>
    #ids{width: 200px;height: 200px;border: 1px solid red}
    .a_name{
        color: #5C8FFC !important;
    }
    .li_item {
        display: inline-block !important;
        vertical-align: top;
    }
    .li_item.bt {
        /*width: 300px;*/
        position: relative;
    }
    .li_item.bt .fa {
        position: absolute;
        right: 10px;
        top: 0;
        width: 40px;
        height: 34px;
        line-height: 34px;
        text-align: center;
        cursor: pointer;
    }

    .li_item {
        display: inline-block !important;
        vertical-align: top;
    }
    .li_item.bt {
        /*width: 300px;*/
        position: relative;
    }
    .li_item.bt .fa {
        position: absolute;
        right: 10px;
        top: 0;
        width: 40px;
        height: 34px;
        line-height: 34px;
        text-align: center;
        cursor: pointer;
    }
    .a_name{
        color: #5C8FFC !important;
    }

    .ui-jqgrid tr.jqgrow td{
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        word-space:nowrap;
    }

    #allcate a{
        margin-right: 5px;
    }
    .breadcrum .blockLi {
        margin: 10px 0;
        display: block;
    }
    .breadcrum .blockLi .ul-c {
        display: inline-block;
        padding: 0;
        float: left;
        width: 90%;
    }
    .breadcrum .blockLi .ul-c li {
        padding: 4px 10px;
        display: inline-block;
        cursor: pointer;
        border: 1px solid #fff;
        border-radius: 5px;
        margin-right: 5px;
    }
    .breadcrum .blockLi .ul-c li.active {
        border: 1px solid #1ab394 ;
        color: #1ab394 ;
    }
    .breadcrum .blockLi .colTitle {
        width: 80px;
        float: left;
        padding-top: 5px;
    }
    .breadcrum .blockLi:before {
        content: "";
        display: none;
    }
    .a_names{
        color: #60b3fa !important;
    }
</style>
<script src="/Public/js/jqGrid/i18n/grid.locale-cnffe4.js" type="text/javascript"></script>
<script src="/Public/js/jqGrid/jquery.jqGrid.minffe4.js" type="text/javascript"></script>
<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="title-bar" style="position: relative;z-index: 99;height: 58px; overflow: hidden;">
                    <div class="row clearfix" id="title-hide" style="display:none;">
                        <ul class="breadcrum pull-left">
                            <li>已选中&nbsp;<span id="icheck_num"></span>&nbsp;项</li>
                            <li class="last_li" style="bottom:10px;"><big><a class="fa fa-times pull-right" id="back-show"></a></big></li>
                        </ul>
                    </div>
                    <div class="row" id="title-show">
                        <ul class="clearfix row" style="margin:0; padding: 0; width: 100%; text-align: right;">
                            <div class="col-lg-8">
                                <!--<span class="chhose_item pull-right" data-val=""><i class="fa fa-square-o"></i></span>-->
                            </div>
                            <li class="li_item col-lg-2">
                                <!--this.options[this.selectedIndex].value-->
                                <select class="form-control" id="changecourse" name="courses">
                                    <option value="" data-value="">请选择班级</option>
                                    <volist name="courses" id="vo">
                                        <option data-value="{$vo.id}">&nbsp;&nbsp;{$vo.name}</option>
                                    </volist>
                                </select>
                            </li>
                            <li class="li_item col-lg-2">
                                <select class="form-control" id="changeper">
                                    <option value="" data-value="">请选择班次</option>
                                    <!--<option v-for="p in periods" :value="p.id">&nbsp;&nbsp;&nbsp;&nbsp;{{p.name}}</option>-->
                                </select>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="table_vue">
                    <table class="" id="table_list_2"></table>
                    <!-- 分页 -->
                    <div id="gridpager"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="videopart" id="record_schedule" style="display: none;">
        <div class="coverbg" @click="close_v()"></div>
        <div class="innerInfo">
            <div class="h3Dv">
                <h3>点击查看视频：</h3>
                <i class="fa fa-close" @click="close_v()"></i>
            </div>
            <ul class="videolist" v-if="current.length > 0">
                <li class="lii_item" v-for="(n,index) in current">
                    <a :href="n.playpath" target="_blank">{{index+1}}. {{n.playpath}}</a>
                </li>
            </ul>
            <ul class="videolist" v-else>
                <li class="lii_item">
                    <a href="javascript:;">暂无视频</a>
                </li>
            </ul>
        </div>
    </div>
</div>
<include file="Publicclass:detail" />
<!--详情-->
<script>
$(function() {
    var record_schedule = new Vue({
        el: '#record_schedule',
        data: {
            current:[]
        },
        methods:{
            close_v:function(){
                $(".videopart").fadeOut();
            },
            getDataById:function(_id){
                var _this = this;
                $.ajax({
                    url:"/index.php?m=education&a=getRecordVideo",
                    type:"post",
                    data:{
                        schedule_id:_id
                    },
                    success:function(res){
                        if (res.status) {
                            _this.current = res.data;
                            console.log("xxx",res);
                        }else{
                            alert(res.msg)
                        }
                    }
                })
                $(".videopart").fadeIn();
                console.log("xxx",_id);
            }
        },
        mounted:function(){
            var _this = this;
            $(document).on('click', '.see_video', function() {
                _this.current = [];
                _this.getDataById($(this).attr("data-sc_id"));
            });
        }
    });
})

function fetchCheckboxValues(name) {
    obj = document.getElementsByName(name);
    check_val = [];
    for (k in obj) {
        if (obj[k].checked)
            check_val.push(obj[k].value);
    }
    return check_val;
}

function dd(data) {
    console.log(data);
    return;
}






function search() {
    $.ajax({
        url: "{:U('case/search')}",
        data: { "cooperation_cate_id": $('#wheres').val() },
        dataType: "JSON",
        type: "POST",
        success: function(obj) {
            if (obj.status == true) {
                renderView(obj.data);
                return;
            } else {
                layer.msg(obj.remark);
            }
        }
    });
}

function showAdd() {
    var url = "{:U('Clueblock/add')}";
    $('#dialog-block-add').dialog('open');
    $('#dialog-block-add').load(url);
}

function renderView(obj) {
    var newHtml = '';
    if (obj != '') {
        $.each(obj, function(k, v) {
            newHtml += createItem(v);
        });
        //            layer.msg('刷新成功!');
    } else {
        layer.msg('无数据!');
    }

    $('#dataStore').html(newHtml);
}

function createItem(item) {
    var itemHtml = "<tr class='controls_tr' data-id='" + item.id + "'>";

    //        itemHtml += "<td><a href='/cases/detail?id=" + item.cooperation_id + "'}'>" + item.cooperation_name + "</a></td>";
    itemHtml += "<td>" + item.names + "</td>";
    itemHtml += "<td>" + item.receive_college + "</td>";
    itemHtml += "<td>" + item.receive_major + "</td>";
    itemHtml += "<td>" + item.undergraduate_college + "</td>";
    itemHtml += "<td>" + item.undergraduate_major + "</td>";
    itemHtml += "<td>" + item.receive_year + "</td>";
    itemHtml += "<td>" + item.japan_language + "</td>";
    itemHtml += "<td>" + item.eng_language + "</td>";
    itemHtml += "<td>" + item.contract_product + "</td>";
    //        itemHtml += "<td>" + item.onlineNum + "</td>";
    //        itemHtml += "<td>" + item.manage_p + "</td>";
    //        itemHtml += "<td>" + item.from_p + "</td>";
    //        itemHtml += "<td>" + item.add_ts + "</td>";
    itemHtml += "<td data-id='" + item.id + "'  title='操作'>";
    itemHtml += "<a href='/publicclass/edit?id=" + item.id + "'}'><button type='button'  class='btn btn-default'>编辑</button></a>";
    itemHtml += "<button type='button' onclick='delThis(" + item.id + ")' class='btn btn-default'>删除</button>";
    itemHtml += "<a href='/case/detail?id=" + item.id + "'}'><button type='button'  class='btn btn-default detail'>详情</button></a>";
    itemHtml += "</td>";
    itemHtml += "</tr>";
    return itemHtml;
}

function showEdit(that) {
    var id = $(that).parent().attr('data-id'),
        url = "{:U('Clueblock/edit')}";
    $('#dialog-block-edit').dialog('open');
    $('#dialog-block-edit').load(url, 'id=' + id);
}

function delThis(that) {
    var id_array = new Array();
    $("input.cbox:checked").each(function() {
        id_array.push($(this).val());
    });
    // 如果为空
    if (id_array.length == 0) {
        alert_crm('你没有选择任何数据！');
        return false;
    }
    console.log(id_array);
    //        return  false;
    layer.alert('', {
        icon: 2,
        title: '删除确认',
        content: '确定删除学员吗?学员对应的分班、签到信息也将删除',
        closeBtn: 1
    }, function(index) {
        //business logic
        $.ajax({
            type: 'post',
            url: 'index.php?m=education&a=student_del',
            data: { id: id_array },
            async: false,
            success: function(data) {
                console.log(data);
                if (data.result == true) {
                    layer.msg('删除成功！')

                    window.location.reload()
                } else {
                    layer.msg('删除失败！请重试！');
                    window.location.reload()
                }
            },
            error: function(data) {
                console.log(data)
            },
            dataType: 'json'
        });
        //            alert(22)
        layer.close(index);
    });
    //        layer.confirm("确认要删除吗，删除后不能恢复", { title: "删除确认" }, function (index) {
    //                layer.close(index);
    //                $.post("/cooperations/delete", { gid: $(e.currentTarget).data("gid") }, function (data) {
    //                    layer.alert(data, {
    //                        title: "删除操作",
    //                        btn: ['确定']
    //                    },
    //                        function (index, item) {
    //                            alert(1)
    //                            //layer.close(index);
    //                            location.reload();
    //                        });
    //                });
    //            });
}

function cluecate(that) {

}

//search();
$(function() {

    // $(document).keyup(function (event) {
    //     if (event.keyCode == 13) {
    //         reloaddata()
    //     }
    // });

    // 多选列表刷新触发事件
    $(".ul-control").on("click", "li", function() {
        //            alert(1)
        $(this).siblings().removeClass("active");
        var _class = $(this).parent().data("name");

        var _val = "";
        if ($(this).attr("data-value") == "") {
            $(this).parent().children().removeClass("active");
            $(this).addClass("active");
            $("input[name='" + _class + "']").val("");
        } else {
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
            } else {
                $(this).addClass("active");
            }
            var _child = $(this).parent().children().length;
            for (var i = 0; i < _child; i++) {
                var _c = $(this).parent().children().eq(i);
                if (_c.hasClass("active") && $(_c).data("value") != "") {
                    _val += $(_c).data("value") + ",";
                }
            }
            _val = _val.substring(0, _val.length - 1);

            if (_val == "") {
                $(this).siblings().eq(0).addClass("active");
            }

            $("input[name='" + _class + "']").val(_val);
        }
        reloaddata()
    });
    $(".ul-controls").on("click", "li", function() {

        if (!$(this).hasClass('bx')) {
            $(this).siblings(":first").removeClass("active");
        }
        //                    $(this).siblings().removeClass("active");
        var _class = $(this).parent().data("name");

        var _val = "";
        if ($(this).attr("data-value") == "") {
            $(this).parent().children().removeClass("active");
            $(this).addClass("active");
            $("input[name='" + _class + "']").val("");
        } else {
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
            } else {
                $(this).addClass("active");
            }
            var _child = $(this).parent().children().length;
            for (var i = 0; i < _child; i++) {
                var _c = $(this).parent().children().eq(i);
                if (_c.hasClass("active") && $(_c).data("value") != "") {
                    _val += $(_c).data("value") + ",";
                }
            }
            _val = _val.substring(0, _val.length - 1);

            if (_val == "") {
                $(this).siblings().eq(0).addClass("active");
            }

            $("input[name='" + _class + "']").val(_val);
        }
        reloaddata()
    });

    $(document).on('change', '#changecourse', function() {
        if ($("#changecourse option:selected").attr('data-value') == '') {
            $("#changeper option:selected").attr('data-value', '')
        }
        $.ajax({
            url: "/index.php?m=education&a=getperbycourse",
            data: { course: $("#changecourse option:selected").attr('data-value') },
            dataType: "JSON",
            type: "POST",
            success: function(res) {
                $('#changeper').empty()
                if (res != null) {
                    $('#changeper').append("<option data-value='' > 请选择课期/班级</option>")
                    $.each(res, function(i, k) {
                        //                        var h = '';
                        //                        h += ;
                        $('#changeper').append("<option data-value='" + k['id'] + "' >&nbsp;&nbsp;" + k['name'] + "</option>")
                    })
                }
            }
        });
        reloaddata()
    });
    $(document).on('change', '#changeper', function() {
        reloaddata()
    });
    $(document).on('click', '.fa-search', function() {
        reloaddata()
    });

    function reloaddata() {
        var _lotwhere = $("#searchInput").val();
        var _program_category = $("#changecourse option:selected").attr('data-value');
        var _major_category = $("#changeper option:selected").attr('data-value')
        console.log(_program_category + "," + _major_category)
        var _data = {
            lotwhere: _lotwhere,
            course: _program_category,
            livecontent: _major_category
        };
        $("#table_list_2").setGridParam({ datatype: 'json', postData: _data }).trigger('reloadGrid');
    }
    $("#table_list_2").clearGridData();

    var _height = $(window).height() - ($(".title-bar").outerHeight() + $("#gridpager").outerHeight() + $("#secondPart").height() + 260);

    $.jgrid.defaults.styleUI = "Bootstrap";

    var icheck_num = 0;

    var qdata = {
        type: ""
    };
    if (getQueryString("cateid") != null) {
        qdata.type = getQueryString("cateid")
        getQueryString("cateid") == "boss" ? qdata.type = "" : "";
    }

    $("#table_list_2").jqGrid({
        url: "{:U('education/record_schedule_list')}",
        datatype: "JSON",
        mtype: "post",
        width: "100%",
        postData: qdata,
        height: _height,
        autowidth: true,
        forceFit: true,
        autoScroll: true,
        multiselect: true,
        useColSpanStyle: true,
        colNames: ["班级名称", "班次名称", "课时名称", "操作"],
        colModel: [{
            name: "course_name",
            index: "course_name",
            editable: false,
            sorttype: "text",
            search: true,
        }, {
            name: "period_name",
            index: "section_name",
            editable: false,
            sorttype: "text",
            search: true,
        }, {
            name: "section_name",
            index: "section_name",
            editable: false,
            sorttype: "text",
            search: true,
        }, {
            name: "id",
            index: "id",
            hidden: false,
            formatter: function(cellvalue, options, cell) {
                return '<a class="btn btn-info btn-sm see_video"  href="javascript:;" data-sc_id="'+cell.sc_id+'">查看回放</a>'
            }
        }],
        forceFit: true,
        //分页
        rowNum: 30,
        rowList: [5, 10, 30],
        pager: '#gridpager',
        viewrecords: true,
        jsonReader: {
            repeatitems: false,
            root: "lists",
            records: "counts",
            total: "total"
        },
        hidegrid: false,
        loadComplete: function(xhr) {
            console.log("xxx", xhr);
        },
        gridComplete: function() {
            var rowIds = jQuery("#table_list_2").jqGrid('getDataIDs');
            var s_ahref = "";
            for (var k = 0; k < rowIds.length; k++) {
                //多选
                var curRowData = jQuery("#table_list_2").jqGrid('getRowData', rowIds[k]);
                var curChk = $("#" + rowIds[k] + "").find("input");
                curChk.attr('value', curRowData['id']); //给checkbox赋值

            }
            resizeTable();
        },
        onSelectRow: function(rowid, status) {
            if (status) {
                icheck_num = icheck_num + 1;
            } else {
                icheck_num = icheck_num - 1;
            }

            $("#icheck_num").text(icheck_num);
            if (icheck_num <= 0) {
                $('#title-hide').hide();
                $('#title-show').show();
            } else {
                $('#title-hide').show();
                $('#title-show').hide();
            }
            //处理单选时才有的操作
            if (icheck_num == 1) {
                $(".single_btn").show().children().each(function() {
                    $(this).attr('rel', $("input.cbox:checked").val());

                    //                        $(".edit_href").attr("href", "/publicclass/edit?id=" + $("input.cbox:checked").val());
                })
            } else {
                $(".single_btn").hide().children().each(function() {
                    $(this).attr('rel', '');
                })
            }

        },
        onSelectAll: function(s, sx) {
            if (sx) {
                $('#title-hide').show();
                $('#title-show').hide();
                icheck_num = s.length
            } else {
                $('#title-hide').hide();
                $('#title-show').show();
                icheck_num = 0
            }
            $("#icheck_num").text(icheck_num)
        }
    }).trigger("reloadGrid"); //重新载入

    jQuery("#table_list_2").jqGrid('navGrid', '#gridpager', { edit: false, add: false, del: false, search: false }, {}, {}, { multipleSearch: true, multipleGroup: true });

    $('.ui-jqgrid-bdiv').niceScroll({
        cursorcolor: "#77B8FF",
        cursoropacitymax: 1,
        cursorwidth: "4px",
        cursorborder: "0",
        cursorborderradius: "0px",
        autohidemode: false
    });

    $('.nicescroll-rails').eq(2).remove()

    $(window).bind("resize", function() {
        resizeTable();
    })



    $(document).on('click', '.edit_href', function() {
        $('#dialog-student-edit').dialog('open');
        $('#dialog-student-edit').load('{:U("educationview/student_edit")}&id=' + $("input.cbox:checked").val());
    });

    function resizeTable() {
        var _height, width;
        _height = $(window).height() - ($(".title-bar").outerHeight() + $("#gridpager").outerHeight()) - 190;
        width = $(".table_vue").width();
        $("#table_list_2").setGridWidth(width)
        $("#table_list_2").setGridHeight(_height)
    }

    function name_format(cellvalue, options, cell) {
        return '<a class="a_name" href="javascript:;" onclick="showDetail(' + cell.id + ')">' + cellvalue + '</a>'
    }

    function customer_nameformat(cellvalue, options, cell) {
        return cellvalue

        // return '<a class="a_name" target="_blank" href="/index.php?m=customer&a=view&id='+cell.customer_id+'&content=" onclick="gotoCustomer(this)" :data-cid="'+cell.customer_id+'">'+cellvalue+'</a>'
    }

    function showPeriodManage(period_id) {
        alert(2)
        if (!period_id) return;
        //$('#dialog-periodmanage-add').dialog('open');
        window.location.href = '{:U("educationview/period_detail")}' + '&id=' + period_id;
        //$('#dialog-periodmanage-add').load('{:U("educationview/period_detail")}' + '&id=' + period_id);
    }
});
</script>
<include file="Public:footer" />