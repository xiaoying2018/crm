<include file="Public:header" />
<style>
    .group_item {
        margin: 5px 0;
    }
    .title-bar{
        padding: 0 15px;
        background: none;
        border:none;
    }
    #title-show{
        padding-top: 10px;
        background: #fff;
    }
    td{
        background-color:#f9fafc;
        padding:14px;
        color:#999;
        text-align:center;
        color:#666;
        border-right: 1px solid #e7eaec;
    }
    td a{
        color: #5C8FFC !important;
    }
</style>
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<div class="wrapper wrapper-content animated fadeIn templete_Detail">
    <div class="row">
        <div class="title-bar col-lg-12">
            <div id="title-show" class="clearfix">
                <ul class="nav pull-left" style="margin:0px 10px 0px 20px;">
                <span>
					<img src="/Public/img/contract_view_icon.png" style="margin-bottom:9px;" alt="">
				</span>
                    <span style="font-size:21px;margin-left:5px">&nbsp;&nbsp;&nbsp;{{detail.period_name}} ({{detail.course_name}}) </span>&nbsp;&nbsp;
                </ul>
        </div>
        <div class="col-lg-12">
            <div class="tabs-container">
                <div style="padding: 20px 20px; background: rgb(255, 255, 255); min-height: 492.48px;" id="left-content">
                    <ul class="nav nav-tabs" id="left_list" style="height:40px;">
                        <li><a href="#tab1" data-toggle="tab" type="tab1">基本信息</a></li>
                        <li><a href="#tab2" data-toggle="tab" type="tab2">排课信息({{count.section}})</a></li>
                        <li><a href="#tab3" data-toggle="tab" type="tab3">学员列表({{count.subStudent}})</a></li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane" id="tab1">
                            <div class="panel-body">

                                <div class="form-horizontal view-group ">
                                    <div class="form-group">
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">班级名称</label>
                                            <div class="col-lg-4"><p>{{detail.period_name}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">所属课程</label>
                                            <div class="col-lg-4">
                                                <p>
                                                    <a target="_blank" :href="'{:U('educationview/course_detail')}&id='+detail.course_id">
                                                        {{detail.course_name}}
                                                    </a>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">课程时长</label>
                                            <div class="col-lg-4"><p>{{detail.time_long}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">成员类型</label>
                                            <div class="col-lg-4">
                                                <p v-if="detail.member_type == 1">一对多</p>
                                                <p v-else>一对一</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">班主任</label>
                                            <div class="col-lg-4"><p>{{detail.headmaster}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">添加人</label>
                                            <div class="col-lg-4"><p>{{detail.creator_name}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">添加时间</label>
                                            <div class="col-lg-4"><p>{{detail.create_at}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">修改人</label>
                                            <div class="col-lg-4"><p>{{detail.updator_name}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">修改时间</label>
                                            <div class="col-lg-4"><p>{{detail.update_at}}</p></div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">课程图片</label>
                                            <div class="col-lg-4">
                                                <p v-if="detail.pic"><img :src="detail.pic" alt=""></p>
                                                <p v-else>无图片</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-12">
                                            <label class="col-lg-2">课程详情</label>
                                            <div class="col-lg-4"><p>{{detail.course_detail}}</p></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab2">
                            <div class="panel-body">
                                <table class="table select-table table-bordered">
                                    <thead>
                                    <tr style="background-color:#f9fafc;text-align:center;">
                                        <td style="">课时名称</td>
                                        <!--<td style="">课时编号</td>-->
                                        <td style="">课时标题</td>
                                        <td style="">课时时长</td>
                                        <td style="">授课老师</td>
                                        <td style="">开始时间</td>
                                        <td style="">结束时间</td>
                                        <td style="">作业</td>
                                        <td style="">创建人</td>
                                        <td style="">创建时间</td>
                                        <td style="">操作</td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr v-for="s in scheduleYet" :data-id="s.schedule_id">
                                        <td style="">{{s.section_name}}</td>
                                        <!--<td style="">{{s.node}}</td>-->
                                        <td style="">{{s.title}}</td>
                                        <td style="">{{s.duration}}</td>
                                        <td style="">{{s.teacher_name}}</td>
                                        <td style="">{{s.start_time}}</td>
                                        <td style="">{{s.end_time}}</td>
                                        <td style="">
                                            <template v-if="s.homework==0"><span class="text-danger" type="button">无</span></template>
                                            <template v-else><span class="text-success" type="button" :title="s.homework_name"><a
                                                    :href="s.homework_path" target="_blank">有</a></span></template>
                                        </td>
                                        <td style="">{{s.creator_name}}</td>
                                        <td style="">{{s.create_at}}</td>
                                        <td style="text-align:center;padding:14px;color:#666">
                                            <template v-if="s.schedule_status == 1 || s.schedule_status == 2" >
                                                <button class="btn btn-success " type="button" @click="chakanKejian(s.schedule_id)" >查看课件</button>
                                                <button class="btn btn-success " type="button" @click="guanlianKejian(s.schedule_id)">关联课件</button>
                                            </template>

                                            <template v-if="s.schedule_status == 1">
                                                <button class="btn btn-info btn-sm" :data-id="s.teacher_user_id"  onclick="notifyTeacher(this)">提醒授课老师</button>
                                            </template>
                                            <template v-else>
                                                <button class="btn btn-success btn-sm" onclick="scheduleSignIn(this)">学员签到管理</button>
                                            </template>
                                            <div class="file-container" style="display:inline-block;position:relative;overflow: hidden;vertical-align:middle">

                                                <button class="btn btn-info fileinput-button" type="button">作业上传</button>
                                                <input type="file" :data-id="s.schedule_id"  onchange="loadFile(this,this.files[0],2)" style="position:absolute;top:0;left:0;font-size:34px; opacity:0">
                                            </div>

                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab3">
                            <div class="panel-body">
                                <table class="table select-table table-bordered">
                                    <thead>
                                    <tr style="background-color:#f9fafc;text-align:center;">
                                        <td style="">学员姓名</td>
                                        <if condition="session('?admin')">
                                            <td style="">学员电话</td>
                                            <td style="">学员邮件</td>
                                        </if>
                                        <td style="">操作</td>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr v-for="s in subStudent" :data-id="s.id">
                                        <td style="">{{s.realname}}</td>
                                        <if condition="session('?admin')">
                                            <td style="">{{s.mobile}}</td>
                                            <td style="">{{s.email}}</td>
                                        </if>
                                        <!--<td style="text-align:center;padding:14px;color:#666">-->
                                            <!--<button class="btn btn-info btn-sm" onclick="notifyStudent()">发消息</button>-->
                                        <!--</td>-->
                                        <td style="text-align:center;padding:14px;color:#666">
                                            <button class="btn btn-danger btn-sm" @click="studentOut(s.id)">踢出班级</button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


    <div style="display:none" id="dialog-periodmanage-add" title="关联课件">
        <div class="spiner-example">
            <div class="sk-spinner sk-spinner-three-bounce">
                <div class="sk-bounce1"></div>
                <div class="sk-bounce2"></div>
                <div class="sk-bounce3"></div>
            </div>
        </div>
    </div>
<!-- 弹框模板定义 -->
<div style="display:none" id="dialog-schedule-signin" title="学员签到管理">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div style="display:none" id="dialog-message-send" title="消息推送">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<include file="Public:footer" />
<script>
    $(function() {
        $("#dialog-periodmanage-add").dialog({
            autoOpen: false,
            modal: true,
            width: '60%',
            maxHeight: 600,
            position: ["center", 100],
            buttons: {
                '取消': function() {
                    $(this).dialog('close');
                }
            },
            close: function() {
                $(this).html('');
            }
        });



        var templete_Detail = new Vue({
            el: '.templete_Detail',
            data: {
                detail:{},
                count:{},
                scheduleYet:{},
                subStudent:{},
            },
            methods:{
                getCourseDetail:function(){
                    var id          =   getQueryString('id');
                    dd(id)
                    if( !id )   return ;
                    var _this       =   this;
                    $.ajax({
                        url:"/index.php?m=education&a=period_detail",
                        data:{id:id},
                        dataType:"JSON",
                        type:"POST",
                        success:function (res) {
                            if( res.result == true ){
                                _this.detail        =   res.detail;
                                _this.count         =   res.count;
                                _this.scheduleYet   =   res.scheduleYet;
                                _this.subStudent    =   res.subStudent;
                            }else{
                                layer.msg( 'ERROR '+res.error );
                            }
                        }
                    });
                },
                section_del:function(btn){
                    var parent          =   $(btn.target).parent().parent(),
                        section_id      =   parent.data('id'),
                        _this           =   this;
                    if( !section_id )   return ;

                    layer.confirm('确定删除课时吗?', {icon: 3, title:'提示'}, function(index){
                        // 删除
                        $.ajax({
                            url:"/index.php?m=education&a=section_del",
                            data:{id:section_id},
                            dataType:"JSON",
                            type:"POST",
                            success:function (res) {
                                dd(res);
                                if( res.result ){
                                    _this.getCourseDetail();
                                    layer.msg('删除成功！');
                                }else{
                                    alert(res.error);
                                }
                            }
                        });
                        layer.close(index);
                    });
                },
                period_del:function(btn){
                    var parent          =   $(btn.target).parent().parent(),
                        period_id       =   parent.data('id'),
                        _this           =   this;
                    if( !period_id )   return ;
                    layer.confirm('确定删除课期(班级)吗?', {icon: 3, title:'提示'}, function(index){
                        // 删除
                        $.ajax({
                            url:"/index.php?m=education&a=period_del",
                            data:{id:period_id},
                            dataType:"JSON",
                            type:"POST",
                            success:function (res) {
                                dd(res);
                                if( res.result ){
                                    _this.getCourseDetail();
                                    layer.msg('删除成功！');
                                }else{
                                    layer.msg("ERROR "+res.error);
                                }
                            }
                        });
                        layer.close(index);
                    });
                },
                PC_del:function(btn){
                    var parent          =   $(btn.target).parent().parent(),
                        ral_id          =   parent.data('id'),
                        _this           =   this;
                    if( !ral_id )   return ;
                    layer.confirm('确定删除产品关联吗?', {icon: 3, title:'提示'}, function(index){
                        // 删除
                        $.ajax({
                            url:"/index.php?m=education&a=courseproduct_del",
                            data:{id:ral_id},
                            dataType:"JSON",
                            type:"POST",
                            success:function (res) {
                                dd(res);
                                if( res.result ){
                                    _this.getCourseDetail();
                                    layer.msg('删除成功！');
                                }else{
                                    layer.msg("ERROR "+res.error);
                                }
                            }
                        });
                        layer.close(index);
                    });
                },


                gotoProductDetail:function(product_id){
                    if( !product_id )   return ;

                    window.open('/index.php?m=product&a=view&id='+product_id);
                },
                guanlianKejian:function(id){
                    $('#dialog-periodmanage-add').load('/index.php?m=course_document&a=getRelatedScheduleList&type=guanlian&schedule_id='+id);
                    $('#dialog-periodmanage-add').dialog('open');
                    //window.location.href='/index.php?m=course_document&a=index&type=guanlian&schedule_id='+id;
                },
                chakanKejian:function(id){
                    $('#dialog-periodmanage-add').load('/index.php?m=course_document&a=getChaKanRelatedScheduleList&type=chakan&schedule_id='+id);
                    $('#dialog-periodmanage-add').dialog('open');
                    // window.location.href='/index.php?m=course_document&a=index&type=chakan&schedule_id='+id;
                },
                studentOut:function(id){
                    if(!id) return ;
                    var _this       =   this;
                    layer.confirm('确定要踢出该学员吗?', {icon: 3, title:'提示'}, function(index){
                        $.ajax({
                            url:"/index.php?m=education&a=periodstudent_del",
                            data:{id:id},
                            dataType:"JSON",
                            type:"POST",
                            success:function (res) {
                                if( res.result == true ){
                                    _this.getCourseDetail();
                                    layer.msg( '踢出学员成功！' );
                                }else{
                                    layer.msg( 'ERROR '+res.error );
                                }
                            }
                        });
                        layer.close(index);
                    });
                }
            },
            mounted: function() {
                $("[type='tab1']").click();
                // 获取详情
                this.getCourseDetail();
            }
        });



        function dd(data) {
            console.log(data)
        }
    });

    // 消息群发
    $("#dialog-message-send").dialog({
        autoOpen: false,
        modal: true,
        width: '50%',
        maxHeight: 600,
        position: ["center",100],
        buttons:{
            '发送':function(){
                var id_array = [];
                id_array.push(tempid);
//                var roleIds         =   fetchCheckboxValues('ids'),
                var roleIds         =   id_array;
                var role            =   1;
                var title           =   $('#message_title').val();
                var message         =   $('#message_content').val();
                var send_types      =   fetchCheckboxValues('types');
                var _this           =   this;

                var data            =   {
                    roleIds:id_array,
                    role:role,
                    title:title,
                    send_types:send_types,
                    message:message
                };
                console.log("xxx",data);
                if( !data.message ){
                    layer.msg('ERROR 内容为空');return;
                }
                $.ajax({
                    url:"{:U('education/notify')}",
                    data:data,
                    dataType:"JSON",
                    type:"POST",
                    success:function(res){
                        if( res.result ){
                            $(_this).dialog('close');
                            layer.msg('发送成功！');
                        }else{
                            layer.msg('ERROR '+res.error);
                        }
                    }
                });
            },
            '关闭':function(){
//                student_container.getLists();
                $(this).dialog('close');
//                location.reload()
            }
        },
        close:function(){
//            student_container.getLists();
            $(this).html('');
//            location.reload()
        }
    });
    window.tempid;
    function notifyTeacher(obj){
        tempid = $(obj).attr("data-id");
        $('#dialog-message-send').dialog('open');
        $('#dialog-message-send').load('{:U("educationview/notify")}');
       // layer.msg('ERROR 开发中');
    }

    function fetchCheckboxValues(name){
        obj = document.getElementsByName(name);
        check_val = [];
        for(k in obj){
            if(obj[k].checked)
                check_val.push(obj[k].value);
        }
        return check_val;
    }

    function notifyStudent(){
        layer.msg('ERROR 开发中');
    }

    $("#dialog-schedule-signin").dialog({
        autoOpen: false,
        modal: true,
        width: '70%',
        maxHeight: 600,
        position: ["center",100],
        buttons:{
            '关闭':function(){
                $(this).dialog('close');
            }
        },
        close:function(){
            $(this).html('');
        }
    });

    function scheduleSignIn(btn) {
        var schedule_id     =   $(btn).parent().parent().attr('data-id');
        if( !schedule_id ){
            layer.msg('ERROR 参数缺失');return ;
        }
        $('#dialog-schedule-signin').dialog('open');
        $('#dialog-schedule-signin').load('{:U("educationview/headmaster_studentsignin")}&id='+schedule_id);
    }

    function loadFile(that,file,type){
        var pobj            =   $(that),
            data            =   new FormData(),
            schedule_id     =   pobj.attr('data-id');
            console.log('课期id'+schedule_id);
        if( !schedule_id ){
            layer.msg('ERROR 参数缺失');return ;
        }
        if( !file ){
            layer.msg('ERROR 请选择文件');return ;
        }

        switch (type){
            case 1:
                // 视频
                data.append('video',file);
                break;
            case 2:
                // 作业
                data.append('homework',file);
                break;
        }
        data.append('id',schedule_id);

        $.ajax({
            url:"{:U('education/schedule_upload')}",
            data:data,
            dataType:"JSON",
            type:"POST",
            processData:false,
            contentType:false,
            async:false,
            success:function (res) {
                if( res.result ){
                    // 刷新主页数据
                    // period_Detail.getPeriodDetail();
                    //
                    layer.msg( '上传成功！' );
                    // 关闭弹框

                }else{
                    layer.msg('ERROR '+res.error);
                }
            }
        });
    }

</script>