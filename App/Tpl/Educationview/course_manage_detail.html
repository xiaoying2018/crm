<include file="Public:header" />
<style>
.group_item {
    margin: 5px 0;
}

.title-bar {
    padding: 0 15px;
    background: none;
    border: none;
}

#title-show {
    padding-top: 10px;
    background: #fff;
}

td {
    background-color: #f9fafc;
    padding: 14px;
    color: #999;
    text-align: center;
    color: #666;
    border-right: 1px solid #e7eaec;
}

td a {
    color: #5C8FFC !important;
}
.videopath_input{
    position: absolute;
    top: -35px;
    left: 0%;
    width: 100%;
    padding: 4px;
    border: 1px solid #20bb65;
    display: none;
    outline: none;
    border-radius: 5px;
    background: #fff;
}
.videopath_input input{
    width: 100%;
    border:none;
    background: none;
    outline: none;
    background: #fff;
}
.videopath_input span{
    position: absolute;
    right: 0;
    top: 0;
    font-size: 14px;
    padding: 4px 8px;
    background-color: #20bb65;
    color: #fff;
    height: 100%;
    cursor: pointer;
}
#sortable tr{
    cursor: all-scroll;
}
</style>
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>



<div class="wrapper wrapper-content animated fadeIn templete_Detail">
    <div class="row">
        <div class="title-bar col-lg-12">
            <div id="title-show" class="clearfix">
                <ul class="nav pull-left" style="margin:0px 10px 0px 20px;">
                    <span>
                    <img src="/Public/img/contract_view_icon.png" style="margin-bottom:9px;" alt="">
                </span>
                    <span style="font-size:21px;margin-left:5px">&nbsp;&nbsp;&nbsp;{{detail.name}}</span>&nbsp;&nbsp;
                </ul>
                <!--<a href="javascript:void(0);" style="margin-right:15px;" class="btn btn-primary pull-right">修改</a> </div>-->
        </div>
            <div style="margin-top: 10px;">
            <div class="tabs-container">
                <div style="padding: 20px 20px; background: rgb(255, 255, 255); min-height: 492.48px;" id="left-content">
                    <ul class="nav nav-tabs" id="left_list" style="height:40px;">
                        <li><a href="#tab1" data-toggle="tab" type="tab1">课程信息</a></li>
                        <li><a href="#tab5" data-toggle="tab" type="tab5">课程详情</a></li>
                        <li><a href="#tab2" data-toggle="tab" type="tab2">课时信息</a></li>

                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane" id="tab1">
                            <div class="panel-body">
                                <div class="form-horizontal view-group ">
                                    <div class="form-group">
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">课程名称</label>
                                            <div class="col-lg-4">
                                                <p>{{detail.name}}</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">课时数</label>
                                            <div class="col-lg-4">
                                                <p>{{count}}</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">添加人</label>
                                            <div class="col-lg-4">
                                                <p>{{detail.create_user}}</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">添加时间</label>
                                            <div class="col-lg-4">
                                                <p>{{detail.create_time}}</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">是否首页显示</label>
                                            <div class="col-lg-4">
                                                <p v-if="detail.is_show">是</p>
                                                <p v-else>否</p>
                                            </div>
                                        </div>
                                        <div class="clearfix group_item col-lg-6">
                                            <label class="col-lg-2">课程图片</label>
                                            <div class="col-lg-4">
                                                <p v-if="detail.pic"><img :src="detail.pic" alt=""></p>
                                                <p v-else>无图片</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab5">
                            <div class="panel-body">
                                <div class="form-horizontal view-group ">
                                    <div class="form-group">
                                        <div class="group_item col-lg-12" id="temp_detail"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane" id="tab2">
                            <div class="panel-body">
                                <a href="javascript:;" onclick="showSectionAdd()" class="btn btn-primary btn-sm addsection" style="margin-bottom:15px;">
                                    <i class="fa fa-plus-circle"></i>&nbsp; 添加课时
                                </a>
                                <table class="table select-table table-bordered">
                                    <thead>
                                        <tr style="background-color:#f9fafc;text-align:center;">
                                            <td style="">课时名称</td>
                                            <td style="">课时编号</td>
                                            <td style="">课时标题</td>
                                            <td style="">课时时长</td>
                                            <td style="">课时视频</td>
                                            <td style="">创建人</td>
                                            <td style="">创建时间</td>
                                            <td style="">操作</td>
                                        </tr>
                                    </thead>
                                    <tbody id="sortable">
                                        <tr v-for="s in sections" :data-id="s.id" class="ui-state-default">
                                            <td style="">
                                                <a href="javascript:;">
                                                {{s.name}}
                                            </a>
                                            </td>
                                            <td style="">{{s.node}}</td>
                                            <td style="">{{s.title}}</td>
                                            <td style="">{{s.duration}}</td>
                                            <!--<td style=""><a v-if="s.video_path != null " :href="s.video_path" target="_blank">试播</a> </td>-->
                                            <td style=""><a v-if="s.video_path != null " :href="s._video_path" target="_blank">试播</a> </td>
                                            <td style="">{{s.create_user}}</td>
                                            <td style="">{{s.create_at}}</td>
                                            <td style="text-align:center;padding:14px;color:#666;">
                                                <div style=" position: relative;">
                                                    <div style="position:relative; display: inline-block;">
                                                        <button class="btn btn-success fileinput-button" type="file" >视频上传</button>
                                                        <!--<input type="file"   :data-id="s.id" onchange="loadFile(this,this.files[0],3)" style="width: 84px;display: inline-block;opacity: 0;left: 50%;position: absolute;top: 0;margin-left: -152px;" class="btn btn-success fileinput-button" value="视频上传" >-->
                                                        <input onclick="uploadVideo(this)"  :data-id="s.id" style="width: 84px;display: inline-block;opacity: 0;left: 0%;position: absolute;top: 0;" class="btn btn-success fileinput-button" value="视频上传" >
                                                    </div>
                                                    <!--<div class="updatevideo" style="position:relative; display: inline-block;">-->
                                                        <!--<button class="btn btn-warning">视频路径修改</button>-->
                                                    <!--</div>-->
                                                    <if condition="session('role_id') == 32 || session('role_id') == 88">
                                                        <!-- todo 需要修改权限,目前时间来不及先定位到某个人 -->
                                                        <else/>
                                                        <button class="btn btn-danger btn-sm" @click="section_del($event)">删除</button>
                                                        <button class="btn btn-info btn-sm" onclick="showSectionEdit(this)">修改</button>
                                                    </if>
                                                    <!--<div class="videopath_input">-->
                                                        <!--<input type="text" placeholder="请输入视频链接" class="">-->
                                                        <!--<span class="confirmvideo" :data-id="s.id" >确定</span>-->
                                                    <!--</div>-->
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 弹框模板定义 -->
<div style="display:none" id="dialog-upload-video" title="上传视频">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>



<div style="display:none" id="dialog-section-add" title="添加课时">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div style="display:none" id="dialog-section-cate-add" title="添加课时">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
<div style="display:none" id="dialog-section-edit" title="修改课时">
    <div class="spiner-example">
        <div class="sk-spinner sk-spinner-three-bounce">
            <div class="sk-bounce1"></div>
            <div class="sk-bounce2"></div>
            <div class="sk-bounce3"></div>
        </div>
    </div>
</div>
    <input type="hidden" id="course_key" >
    <input type="hidden" id="course_id" >
    <input type="hidden" id="course_hash" >
<include file="Public:footer" />
</div>
<script>

var templete_Detail;
$(function() {
    // 上传视频

    $("#dialog-upload-video").dialog({
        autoOpen: false,
        // modal: true, 影响分类选择插件
        width: '55%',
        maxHeight: 600,
        position: ["center", 100],
        buttons: {
            '确认上传': function () {
                // 操作
                if($('#course_key').val()=='' || $('#course_key').val()==undefined){
                    return  layer.msg('请先选择要上传视频！');
                }
                var _dialog = this,
                    data = {};
                data['course_id'] = $('#course_id').val();
                data['key'] = $('#course_key').val();
                //data['key'] = $('#course_key').val();
                console.log(data);
                //return;
                $.ajax({
                    url: "{:U('education/new_upload_video')}",
                    data: data,
                    dataType: "JSON",
                    type: "POST",
                    success: function (res) {
                        if (res.result) {
                            // 刷新主页数据
                            templete_Detail.getCourseDetail();
                            //
                            layer.msg('上传成功！');
                            // 关闭弹框
                            $(_dialog).dialog('close');
                            $('#course_id').val('');
                            $('#course_key').val('');
                            $('#course_hash').val('');

                        } else {
                            layer.msg('ERROR ' + res.error);
                        }
                    }
                });
                return;
            }
        },
        close: function () {
            $('#course_id').val('');
            $('#course_key').val('');
            $('#course_hash').val('');
            // $("#dialog-upload-video").dialog('close');
        }
    });
    $(document).on('click','.updatevideo',function(){
        $(this).parent().find(".videopath_input").show();
    })

    $(document).on('click','.confirmvideo',function(){
        var _val = $(this).prev().val();
        var _id = $(this).attr("data-id")
        if (_val == ''){
            return false;
        }
        if (_val.indexOf('http://') > -1){
            _val = _val.replace('http://','')
        }
        var _data = {
            id:_id,
            path:_val
        }
        $.ajax({
            url:"{:U('education/section_video_path_change')}",
            type:'post',
            data:_data,
            success:function(res){
                alert('修改成功');
                $('.videopath_input').hide();
            }
        })
        console.log(_data)
    })
    templete_Detail = new Vue({
        el: '.templete_Detail',
        data: {
            detail: {},
            sections: {},
            count: {},
        },
        methods: {
            getCourseDetail: function () {
                var id = getQueryString('id');
                if (!id) return;
                var _this = this;
                $.ajax({
                    url: "/index.php?m=education&a=course_manage_detail",
                    data: {id: id},
                    dataType: "JSON",
                    type: "POST",
                    success: function (res) {
                        console.log(res)
                        if (res.result == true) {
                            _this.detail = res.detail
                            function escapeStringHTML(str) {
                                str = str.replace(/&lt;/g, '<');
                                str = str.replace(/&gt;/g, '>');
                                str = str.replace(/&amp;/g, '"');
                                str = str.replace(/&quot;/g, '"');
                                str = str.replace(/&#039;/g, "'");
                                return str;
                            }

                            $("#temp_detail").html(escapeStringHTML(res.detail.detail))
                            _this.sections = res.sections;
                            _this.count = res.count;

                            $( "#sortable" ).sortable({
                              stop: function( event, ui) {
                                var _arr = [];
                                $("#sortable tr").each(function(){
                                    var _el = $(this);
                                    var _temp = {
                                        id:"",
                                        node:""
                                    }
                                    _temp.id = $(_el).attr("data-id")
                                    _temp.node = $(_el).index() + 1
                                    _arr.push(_temp);
                                })
                                $.ajax({
                                    url:"{:U('education/change_section_sort')}",
                                    type:'post',
                                    dataType:"json",
                                    data:{
                                        new_node:_arr
                                    },
                                    success:function(res){
                                        // console.log("xxx",res);
                                    }
                                })
                              }
                            });
                            $( "#sortable" ).disableSelection();
                        } else {
                            alert(res.error);
                        }
                    }
                });
            },
            section_del: function (btn) {
                var parent = $(btn.target).parent().parent().parent(),
                    section_id = parent.data('id'),
                    _this = this;
                if (!section_id) return;

                layer.confirm('确定删除课时吗?', {icon: 3, title: '提示'}, function (index) {
                    // 删除
                    $.ajax({
                        url: "/index.php?m=education&a=section_del",
                        data: {id: section_id},
                        dataType: "JSON",
                        type: "POST",
                        success: function (res) {
                            if (res.result) {
                                _this.getCourseDetail();
                                layer.msg('删除成功！');
                            } else {
                                alert(res.error);
                            }
                        }
                    });
                    layer.close(index);
                });
            },
        },
        mounted: function () {
            $("[type='tab1']").click();
            // 获取详情
            this.getCourseDetail();
        }
    });


    // 添加课时弹框显示
    $("#dialog-section-add").dialog({
        autoOpen: false,
        // modal: true, 影响分类选择插件
        width: '55%',
        maxHeight: 600,
        position: ["center", 100],
        buttons: {
            '添加': function () {
                // 操作
                var course_id = templete_Detail.detail.id,
                    form_data = $('#section_add_form').serializeArray(),
                    data = {},
                    _dialog = this;
                form_data.forEach(function (v) {
                    data[v.name] = v.value;
                });
                data['course_id'] = course_id;
                $.ajax({
                    url: "{:U('education/section_add')}",
                    data: data,
                    dataType: "JSON",
                    type: "POST",
                    success: function (res) {
                        if (res.result) {
                            // 刷新主页数据
                            templete_Detail.getCourseDetail();
                            //
                            layer.msg('添加成功！');
                            // 关闭弹框
                            $(_dialog).dialog('close');

                        } else {
                            layer.msg('ERROR ' + res.error);
                        }
                    }
                });
                return;
            },
            '取消': function () {
                $(this).dialog('close');
            }
        },
        close: function () {
            $(this).html('');
        }
    });
    // 修改课时弹框显示
    $("#dialog-section-edit").dialog({
        autoOpen: false,
        modal: true,
        width: '55%',
        maxHeight: 600,
        position: ["center", 100],
        buttons: {
            '修改': function () {
                // 操作
                var course_id = course_id,
                    form_data = $('#section_add_form').serializeArray(),
                    data = {},
                    _dialog = this;
                form_data.forEach(function (v) {
                    data[v.name] = v.value;
                });
                $.ajax({
                    url: "{:U('education/section_edit')}",
                    data: data,
                    dataType: "JSON",
                    type: "POST",
                    success: function (res) {
                        if (res.result) {
                            // 刷新主页数据
                            templete_Detail.getCourseDetail();
                            //
                            layer.msg('课时修改成功！');
                            // 关闭弹框
                            $(_dialog).dialog('close');

                        } else {
                            layer.msg('ERROR ' + res.error);
                        }
                    }
                });
                return;
            },
            '取消': function () {
                $(this).dialog('close');
            }
        },
        close: function () {
            $(this).html('');
        }
    });
});
    // function dd(data) {
    //     console.log(data)
    // }




function loadFile(that,file,type){
    var pobj            =   $(that),
        data            =   new FormData(),
        schedule_id     =   pobj.attr('data-id');
    if( !schedule_id ){
        layer.msg('ERROR 参数缺失');return ;
    }
    if( !file ){
        layer.msg('ERROR 请选择文件');return ;
    }
    switch (type){
        case 1:
            // 视频
            data.append('video',file);
            break;
        case 2:
            // 作业
            data.append('homework',file);
            break;
        case 3:
            // 课程视频
            data.append('old_video',file);
            break;
    }
    data.append('id',schedule_id);
    $.ajax({
        url:"{:U('education/schedule_upload')}",
        data:data,
        dataType:"JSON",
        type:"POST",
        processData:false,
        contentType:false,
        async:false,
        success:function (res) {
            if( res.result ){
                // 刷新主页数据
                templete_Detail.getCourseDetail()
                //window.location.reload(true);
                //
                layer.msg( '上传成功！' );
                // 关闭弹框

            }else{
                layer.msg('ERROR '+res.error);
            }
        }
    });
}

// 课时修改
function showSectionEdit(btn) {
    var id = $(btn).parent().parent().parent().attr('data-id');
    if (!id) {
        layer.msg('主键缺失');
        return;
    }
    $('#dialog-section-edit').dialog('open');
    $('#dialog-section-edit').load('{:U("educationview/section_edit")}&id=' + id);
}

// 课时添加
function showSectionAdd() {
    $('#dialog-section-add').dialog('open');
    $('#dialog-section-add').load('{:U("educationview/section_add")}');
}

// 视频上传
function uploadVideo(obj) {
    $("#box2").show();
    console.log($)
    $('#course_id').val($(obj).attr('data-id'))  ;
    console.log(course_id);
    $('#dialog-upload-video').dialog('open');
    $('#dialog-upload-video').load('{:U("educationview/upload_video")}');
    // $('[aria-describedby="dialog-upload-video"]')
}



</script>